import { Client, Message } from '@open-wa/wa-automate';
import { Command } from '../middlewares/commandParser';
import { User, Usage, Reminder, Group } from '../database/models';
import { formatBox } from '../utils/formatter';
import config from '../utils/config';

/**
 * Clear All Command
 * Nuclear option to clear all bot data - Owner only
 * Features comprehensive data removal, confirmation system, and detailed logging
 */
export const clearallCommand: Command = {
  name: 'clearall',
  aliases: ['cleardata', 'resetdb', 'nuke'],
  description: 'Hapus semua data pengguna dan reset database (khusus owner)',
  category: 'Owner',
  cooldown: 30,
  usage: '!clearall CONFIRM',
  example: '!clearall CONFIRM',
  adminOnly: false,
  ownerOnly: true,
  
  /**
   * Execute the clearall command
   * @param message - WhatsApp message object
   * @param args - Command arguments [CONFIRM]
   * @param client - WhatsApp client instance
   * @param user - Owner user database object
   */
  async execute(message: Message, args: string[], client: Client, user?: User): Promise<void> {
    try {
      console.log(`üßπ Processing clearall command from owner ${message.sender.id}`);
      
      // Additional owner verification (safety check)
      if (String(message.sender.id) !== config.ownerNumber) {
        console.log(`‚ùå Unauthorized clearall attempt by ${message.sender.id}`);
        await client.reply(
          message.chatId,
          'üö´ *Akses Ditolak*\n\n' +
          'Perintah ini hanya dapat digunakan oleh owner bot.\n\n' +
          '_Ini adalah operasi destruktif yang sangat sensitif._',
          message.id
        );
        return;
      }

      // Check for confirmation
      if (args.length === 0 || args[0] !== 'CONFIRM') {
        console.log('‚ö†Ô∏è Clearall requested without confirmation');
        
        // Get current data counts for information
        let dataCounts = '';
        try {
          const userCount = await User.count();
          const usageCount = await Usage.count();
          const reminderCount = await Reminder.count();
          const groupCount = await Group.count();
          
          dataCounts = `üìä *Data Saat Ini:*\n` +
            `üë• Pengguna: ${userCount}\n` +
            `üìà Usage Data: ${usageCount}\n` +
            `‚è∞ Reminder: ${reminderCount}\n` +
            `üë• Grup: ${groupCount}\n\n`;
        } catch (countError) {
          console.error('Error counting data:', countError);
          dataCounts = 'üìä *Data Saat Ini:* Tidak dapat dihitung\n\n';
        }
        
        const warningMessage = `üö® *PERINGATAN KRITIS*\n\n` +
          `‚ö†Ô∏è **OPERASI DESTRUKTIF**\n` +
          `Perintah ini akan menghapus SEMUA data bot!\n\n` +
          dataCounts +
          `üóëÔ∏è *Yang Akan Dihapus:*\n` +
          `‚Ä¢ Semua pengguna terdaftar\n` +
          `‚Ä¢ Semua data penggunaan/limit\n` +
          `‚Ä¢ Semua reminder aktif\n` +
          `‚Ä¢ Semua data grup\n` +
          `‚Ä¢ Semua riwayat aktivitas\n\n` +
          `‚ùå **TINDAKAN INI TIDAK DAPAT DIBATALKAN!**\n\n` +
          `‚ö° *Untuk melanjutkan, ketik:*\n` +
          `\`!clearall CONFIRM\`\n\n` +
          `_Pastikan Anda benar-benar yakin sebelum melakukan ini._`;

        await client.reply(
          message.chatId,
          formatBox('‚ö†Ô∏è KONFIRMASI DIPERLUKAN', warningMessage),
          message.id
        );
        return;
      }

      console.log('üî• Clearall confirmed, starting data destruction process');

      // Send initial warning with countdown
      const initialWarning = `üö® *PROSES PENGHAPUSAN DIMULAI*\n\n` +
        `‚ö†Ô∏è Menghapus semua data dalam 3 detik...\n` +
        `‚ùå Ini adalah kesempatan terakhir untuk membatalkan!\n\n` +
        `_Proses akan dimulai dalam beberapa detik._`;
      
      await client.reply(
        message.chatId,
        formatBox('üö® PERINGATAN', initialWarning),
        message.id
      );

      // 3 second delay for last-chance cancellation
      await new Promise(resolve => setTimeout(resolve, 3000));

      console.log('üíÄ Starting database destruction');

      // Count current data before destruction
      let userCount = 0;
      let usageCount = 0;
      let reminderCount = 0;
      let groupCount = 0;
      
      try {
        userCount = await User.count();
        usageCount = await Usage.count();
        reminderCount = await Reminder.count();
        groupCount = await Group.count();
        
        console.log(`üìä Data to be destroyed: Users(${userCount}), Usage(${usageCount}), Reminders(${reminderCount}), Groups(${groupCount})`);
      } catch (countError) {
        console.error('‚ùå Error counting data before destruction:', countError);
      }

      // Send progress message
      await client.reply(
        message.chatId,
        'üîÑ *Memproses penghapusan data...*\n\n_Harap tunggu, jangan matikan bot._',
        message.id
      );

      // Start destruction process with error handling for each step
      const destructionLog: string[] = [];
      let totalDestroyed = 0;

      try {
        // Step 1: Clear Usage data
        console.log('üóëÔ∏è Destroying usage data...');
        const usageDestroyed = await Usage.destroy({ where: {}, force: true });
        destructionLog.push(`‚úÖ Usage data: ${usageDestroyed} records`);
        totalDestroyed += usageDestroyed;
      } catch (error) {
        console.error('‚ùå Error destroying usage data:', error);
        destructionLog.push(`‚ùå Usage data: Error occurred`);
      }

      try {
        // Step 2: Clear Reminder data
        console.log('üóëÔ∏è Destroying reminder data...');
        const reminderDestroyed = await Reminder.destroy({ where: {}, force: true });
        destructionLog.push(`‚úÖ Reminder data: ${reminderDestroyed} records`);
        totalDestroyed += reminderDestroyed;
      } catch (error) {
        console.error('‚ùå Error destroying reminder data:', error);
        destructionLog.push(`‚ùå Reminder data: Error occurred`);
      }

      try {
        // Step 3: Clear Group data
        console.log('üóëÔ∏è Destroying group data...');
        const groupDestroyed = await Group.destroy({ where: {}, force: true });
        destructionLog.push(`‚úÖ Group data: ${groupDestroyed} records`);
        totalDestroyed += groupDestroyed;
      } catch (error) {
        console.error('‚ùå Error destroying group data:', error);
        destructionLog.push(`‚ùå Group data: Error occurred`);
      }

      try {
        // Step 4: Clear User data (last, as it may have foreign key constraints)
        console.log('üóëÔ∏è Destroying user data...');
        const userDestroyed = await User.destroy({ where: {}, force: true });
        destructionLog.push(`‚úÖ User data: ${userDestroyed} records`);
        totalDestroyed += userDestroyed;
      } catch (error) {
        console.error('‚ùå Error destroying user data:', error);
        destructionLog.push(`‚ùå User data: Error occurred`);
      }

      // Compile destruction report
      const timestamp = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
      
      const successMessage = `‚úÖ *DATABASE BERHASIL DIRESET*\n\n` +
        `üóëÔ∏è *Statistik Penghapusan:*\n` +
        destructionLog.map(log => `${log}`).join('\n') + '\n\n' +
        `üìä *Total Records Dihapus:* ${totalDestroyed}\n` +
        `‚è∞ *Waktu:* ${timestamp}\n` +
        `üëë *Oleh:* Owner (${message.sender.pushname || config.ownerNumber})\n\n` +
        `üîÑ *Status:* Database telah direset sepenuhnya!\n` +
        `‚ö° *Bot siap digunakan dengan data kosong.*\n\n` +
        `_Semua pengguna harus registrasi ulang._`;

      await client.reply(
        message.chatId,
        formatBox('‚úÖ PENGHAPUSAN SELESAI', successMessage),
        message.id
      );

      // Log the operation
      console.log(`üíÄ Database cleared successfully by owner ${message.sender.id}`);
      console.log(`üìä Total records destroyed: ${totalDestroyed}`);
      console.log(`üïê Operation completed at: ${timestamp}`);

      // Send follow-up information after a delay
      setTimeout(async () => {
        try {
          const followUpMessage = `üìã *Info Pasca Reset*\n\n` +
            `üîß *Yang Perlu Dilakukan:*\n` +
            `‚Ä¢ Restart bot (opsional)\n` +
            `‚Ä¢ Informasikan ke pengguna untuk registrasi ulang\n` +
            `‚Ä¢ Monitor performa bot\n\n` +
            `üìù *Catatan:*\n` +
            `‚Ä¢ Konfigurasi bot tetap utuh\n` +
            `‚Ä¢ Database schema tidak berubah\n` +
            `‚Ä¢ Bot dapat langsung digunakan\n\n` +
            `_Reset database berhasil diselesaikan._`;
          
          await client.reply(
            message.chatId,
            formatBox('üìã INFORMASI', followUpMessage),
            message.id
          );
        } catch (followUpError) {
          console.error('‚ùå Failed to send follow-up message:', followUpError);
        }
      }, 5000); // 5 second delay

    } catch (error) {
      console.error('‚ùå Critical error in clearall command:', error);
      
      // Enhanced error handling for critical operations
      let errorMessage = 'Terjadi kesalahan kritis saat menghapus data.';
      
      if (error instanceof Error) {
        if (error.message.includes('database')) {
          errorMessage = 'Kesalahan database saat menghapus data. Beberapa data mungkin masih tersisa.';
        } else if (error.message.includes('permission')) {
          errorMessage = 'Kesalahan izin saat mengakses database.';
        } else if (error.message.includes('constraint')) {
          errorMessage = 'Kesalahan constraint database. Ada dependensi data yang mencegah penghapusan.';
        }
        console.error('ClearAll error details:', error.message);
        console.error('Error stack:', error.stack);
      }
      
      try {
        await client.reply(
          message.chatId,
          `‚ùå *OPERASI GAGAL*\n\n` +
          `${errorMessage}\n\n` +
          `üîß *Saran:*\n` +
          `‚Ä¢ Cek log untuk detail error\n` +
          `‚Ä¢ Restart bot jika diperlukan\n` +
          `‚Ä¢ Hubungi support teknis\n\n` +
          `_Database mungkin dalam keadaan tidak konsisten._`,
          message.id
        );
      } catch (replyError) {
        console.error('‚ùå Failed to send clearall error message:', replyError);
      }
    }
  }
};

export default clearallCommand;